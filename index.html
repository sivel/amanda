<!DOCTYPE html>
<html lang="en" class="bg-gray-50">
<head>
    <meta charset="UTF-8">
    <title x-text="pageTitle">Collections Browser</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/compare-versions/lib/umd/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <style>
        @layer components {
            .markdown-content h1 {font-size: 1.875rem; line-height: 2.25rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 1rem;}
            .markdown-content h2 {font-size: 1.5rem; line-height: 2rem; font-weight: 700; margin-top: 1.5rem; margin-bottom: 0.75rem;}
            .markdown-content h3 {font-size: 1.25rem; line-height: 1.75rem; font-weight: 600; margin-top: 1rem; margin-bottom: 0.5rem;}
            .markdown-content h4 {font-size: 1.125rem; line-height: 1.75rem; font-weight: 600; margin-top: 0.75rem; margin-bottom: 0.5rem;}
            .markdown-content p {margin-bottom: 1rem;}
            .markdown-content ul {list-style-type: disc; margin-left: 1.5rem; margin-bottom: 1rem;}
            .markdown-content ul li {margin-bottom: 0.25rem;}
            .markdown-content code {
                background-color: #f3f4f6; padding: 0.125rem 0.375rem; border-radius: 0.25rem; font-size: 0.875rem; line-height: 1.25rem;
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
            }
            .markdown-content pre {background-color: #f3f4f6; padding: 1rem; border-radius: 0.25rem; overflow-x: auto; margin-bottom: 1rem;}
            .markdown-content pre code {background-color: transparent; padding: 0;}
            .markdown-content img {max-width: 100%;height: auto;}
        }
    </style>
</head>
<body class="p-4 sm:p-6" x-data="collectionsApp()" x-init="init()">

    <div x-show="view === 'list'">
        <div class="max-w-7xl mx-auto px-4 mb-4">
            <h1 class="text-2xl font-bold mb-4">Collections</h1>

            <div class="mb-2 flex items-center space-x-2 text-gray-700 font-medium">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                          d="M3 4a1 1 0 0 1 1-1h16a1 1 0 0 1 .8 1.6l-6.2 8.3V20a1 1 0 0 1-1.4.9l-4-2A1 1 0 0 1 9 18v-5.1L2.2 5.6A1 1 0 0 1 3 4Z"/>
                </svg>
                <span>Filter Collections</span>
            </div>

            <div class="flex space-x-2">
                <input id="searchNamespace" type="text" class="border px-2 py-1 rounded" placeholder="Namespace" x-model="searchNamespace">
                <input type="text" class="border px-2 py-1 rounded" placeholder="Name" x-model="searchName">
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 max-w-7xl mx-auto px-4">
            <template x-for="col in filteredCollections" :key="col.namespace.name + '.' + col.name">
                <div class="bg-white shadow rounded-xl p-6 cursor-pointer hover:shadow-xl hover:bg-blue-50 active:scale-[0.98] transition-all duration-150 ease-in-out" @click="openCollection(col)">
                    <div class="text-gray-500 text-sm" x-text="col.namespace"></div>
                    <div class="text-xl font-semibold" x-text="col.name"></div>
                    <template x-if="col.highest_version?.version">
                        <div class="text-sm text-gray-600" x-text="'Latest: ' + col.highest_version.version"></div>
                    </template>
                </div>
            </template>
        </div>
    </div>

    <div x-show="view === 'detail'">
        <div class="max-w-7xl mx-auto px-4 mb-4">
            <button class="mb-4 text-blue-500 underline" @click="goBack()">&larr; Back</button>
            <h2 class="text-2xl font-bold mb-2" x-text="(currentCollection?.namespace || '') + '/' + (currentCollection?.name || '')"></h2>
            <div class="relative inline-block max-w-[14rem] mb-4">
                <label class="block mb-1">Version:</label>
                <select x-model="selectedVersion" @change="fetchVersionDetails" class="appearance-none bg-white border border-gray-300 rounded-lg shadow px-4 py-2 pr-10 text-base text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-300 focus:border-blue-500 w-full">
                    <template x-for="v in versions" :key="v.version">
                        <option :value="v.version" x-text="v.version"></option>
                    </template>
                </select>
                <div class="pointer-events-none absolute right-3 top-[70%] -translate-y-1/2 text-gray-400">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow mt-6" x-show="hasLinks">
                <div class="flex items-center space-x-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" />
                    </svg>
                    <h3 class="text-lg font-semibold">Links</h3>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <template x-if="versionDetails.metadata?.repository">
                        <a :href="versionDetails.metadata.repository" target="_blank" class="flex items-center space-x-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 14.15v4.25c0 1.094-.787 2.036-1.872 2.18-2.087.277-4.216.42-6.378.42s-4.291-.143-6.378-.42c-1.085-.144-1.872-1.086-1.872-2.18v-4.25m16.5 0a2.18 2.18 0 0 0 .75-1.661V8.706c0-1.081-.768-2.015-1.837-2.175a48.114 48.114 0 0 0-3.413-.387m4.5 8.006c-.194.165-.42.295-.673.38A23.978 23.978 0 0 1 12 15.75c-2.648 0-5.195-.429-7.577-1.22a2.016 2.016 0 0 1-.673-.38m0 0A2.18 2.18 0 0 1 3 12.489V8.706c0-1.081.768-2.015 1.837-2.175a48.111 48.111 0 0 1 3.413-.387m7.5 0V5.25A2.25 2.25 0 0 0 13.5 3h-3a2.25 2.25 0 0 0-2.25 2.25v.894m7.5 0a48.667 48.667 0 0 0-7.5 0M12 12.75h.008v.008H12v-.008Z" />
                            </svg>
                            <span>Repository</span>
                        </a>
                    </template>
                    <template x-if="versionDetails.metadata?.documentation">
                        <a :href="versionDetails.metadata.documentation" target="_blank" class="flex items-center space-x-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 0 0 6 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 0 1 6 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 0 1 6-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0 1 18 18a8.967 8.967 0 0 0-6 2.292m0-14.25v14.25" />
                            </svg>
                            <span>Documentation</span>
                        </a>
                    </template>
                    <template x-if="versionDetails.metadata?.homepage">
                        <a :href="versionDetails.metadata.homepage" target="_blank" class="flex items-center space-x-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                            </svg>
                            <span>Homepage</span>
                        </a>
                    </template>
                    <template x-if="versionDetails.metadata?.issues">
                        <a :href="versionDetails.metadata.issues" target="_blank" class="flex items-center space-x-2 text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 1 1-18 0 9 9 0 0 1 18 0Zm-9 3.75h.008v.008H12v-.008Z" />
                            </svg>
                            <span>Issues</span>
                        </a>
                    </template>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow mt-6">
                <div class="flex items-center space-x-2 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5M16.5 12 12 16.5m0 0L7.5 12m4.5 4.5V3" />
                    </svg>
                    <h3 class="text-lg font-semibold">Download</h3>
                </div>
                <a :href="versionDetails.download_url" class="inline-block text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition-colors">Download tarball</a>
            </div>

            <div class="bg-white p-4 rounded-xl shadow mt-6">
                <div class="flex items-center space-x-2 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m6.75 7.5 3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0 0 21 18V6a2.25 2.25 0 0 0-2.25-2.25H5.25A2.25 2.25 0 0 0 3 6v12a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                    <h3 class="text-lg font-semibold">Install</h3>
                </div>
                <div class="flex items-center space-x-2 mt-1">
                    <code class="block bg-gray-100 p-2 rounded text-sm" x-ref="installCmd">
                        ansible-galaxy collection install -s <span x-text="installURL"></span> <span x-text="installName"></span>
                    </code>
                    <button @click="copyInstallCmd" class="text-sm px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">
                        Copy
                    </button>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow mt-6" x-show="hasDependencies">
                <div class="flex items-center space-x-2 mb-3">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 16.875h3.375m0 0h3.375m-3.375 0V13.5m0 3.375v3.375M6 10.5h2.25a2.25 2.25 0 0 0 2.25-2.25V6a2.25 2.25 0 0 0-2.25-2.25H6A2.25 2.25 0 0 0 3.75 6v2.25A2.25 2.25 0 0 0 6 10.5Zm0 9.75h2.25A2.25 2.25 0 0 0 10.5 18v-2.25a2.25 2.25 0 0 0-2.25-2.25H6a2.25 2.25 0 0 0-2.25 2.25V18A2.25 2.25 0 0 0 6 20.25Zm9.75-9.75H18a2.25 2.25 0 0 0 2.25-2.25V6A2.25 2.25 0 0 0 18 3.75h-2.25A2.25 2.25 0 0 0 13.5 6v2.25a2.25 2.25 0 0 0 2.25 2.25Z" />
                    </svg>
                    <h3 class="text-lg font-semibold">Dependencies</h3>
                </div>
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                    <template x-for="[name, version] in dependencyEntries" :key="name">
                        <a href="#" @click.prevent="openDependency(name, version)" class="flex items-center text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-2 rounded transition-colors"><span class="font-medium" x-text="name"></span></a>
                    </template>
                </div>
            </div>

            <div class="bg-white p-4 rounded-xl shadow mt-6" x-show="renderedReadme">
                <div class="flex items-center space-x-2 mb-1">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-gray-700">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                    </svg>
                    <h3 class="text-lg font-semibold">Documentation</h3>
                </div>
                <div class="mt-1 markdown-content" x-html="renderedReadme"></div>
            </div>
        </div>
    </div>

    <div x-show="showToast" x-transition
         class="fixed bottom-4 right-4 z-50 bg-green-500 text-white px-4 py-2 rounded shadow-lg text-sm">
        Copied to clipboard!
    </div>

    <div x-show="loading" x-transition.opacity class="fixed inset-0 z-50 flex items-center justify-center bg-white/60 backdrop-blur-sm" aria-label="Loading">
        <svg class="animate-spin h-8 w-8 text-gray-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"/>
        </svg>
    </div>

    <script>
        function collectionsApp() {
            return {
                view: 'list',
                searchNamespace: '',
                searchName: '',
                collections: [],
                currentCollection: null,
                versions: [],
                selectedVersion: '',
                versionDetails: {},
                docs: {},
                renderedReadme: '',
                showToast: false,
                pageTitle: 'Collections Browser',

                withLoading(fn) {
                    return async (...args) => {
                        this.loading = true;
                        try {
                            return await fn.apply(this, args);
                        } finally {
                            this.loading = false;
                        }
                    };
                },

                async init() {
                    if (this._initCalled) return;
                    this._initCalled = true;

                    this.fetchCollections = this.withLoading(this.fetchCollections);
                    this.fetchVersionDetails = this.withLoading(this.fetchVersionDetails);
                    this.openCollection = this.withLoading(this.openCollection);

                    await this.fetchCollections();

                    this.$watch('showToast', value => {
                        if (value) {
                             setTimeout(() => this.showToast = false, 2000);
                        }
                    });
                    this.$watch('pageTitle', value => document.title = value);
                    this.$watch('searchNamespace', () => this.updateFilterHash());
                    this.$watch('searchName', () => this.updateFilterHash());
                },

                async fetchCollections() {
                    const res = await fetch('/api/v3/collections/');
                    const data = await res.json();
                    this.collections = data.data.sort((a, b) => {
                        const nameA = a.namespace + '.' + a.name;
                        const nameB = b.namespace + '.' + b.name;
                        return nameA.localeCompare(nameB);
                    });

                    await this.handleRoute();
                },

                get filteredCollections() {
                    return this.collections.filter(c =>
                        c.namespace.includes(this.searchNamespace) &&
                        c.name.includes(this.searchName)
                    );
                },

                async handleRoute() {
                    const hash = window.location.hash;

                    const detailMatch = hash.match(/^#\/([^/?#]+)\/([^/?#]+)(?:\/([^/?#]+))?$/);
                    if (detailMatch) {
                        const [_, namespace, name, version] = detailMatch;
                        const col = this.collections.find(c => c.namespace === namespace && c.name === name);
                        if (col) {
                            await this.openCollection(col, version, true);
                        }
                        return;
                    }

                    const filterMatch = hash.match(/^#\/filter\?(.*)$/);
                    if (filterMatch) {
                        const query = new URLSearchParams(filterMatch[1]);
                        this.searchNamespace = query.get('ns') || '';
                        this.searchName = query.get('name') || '';
                    }
                },

                updateFilterHash() {
                    if (this.view !== 'list') return;

                    const params = new URLSearchParams();
                    if (this.searchNamespace) params.set('ns', this.searchNamespace);
                    if (this.searchName) params.set('name', this.searchName);

                    const query = params.toString();
                    window.location.hash = query ? `#/filter?${query}` : '';
                },

                updateDetailHash() {
                    if (!this.currentCollection) return;

                    const ns = this.currentCollection.namespace.name;
                    const name = this.currentCollection.name;
                    const ver = this.selectedVersion;
                    window.location.hash = `#/${ns}/${name}/${ver}`;
                },

                goBack() {
                    this.view = 'list';
                    this.pageTitle = 'Collections Browser';
                    this.selectedVersion = '';
                    this.versionDetails = {};
                    this.currentCollection = null;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    window.location.hash = '';
                },

                async openCollection(col, versionOverride = null, skipHashUpdate = false) {
                    this.currentCollection = col;
                    this.view = 'detail';
                    this.pageTitle = `${col.namespace}.${col.name}`;

                    const res = await fetch(col.versions_url);
                    const data = await res.json();
                    this.versions = data.data;

                    this.selectedVersion = versionOverride || col.highest_version?.version || this.versions[0].version;
                    await this.fetchVersionDetails();
                    if (!skipHashUpdate) {
                        window.location.hash = `#/${col.namespace}/${col.name}/${this.selectedVersion}`;
                    }
                    await this.fetchDocs();
                },

                async fetchVersionDetails() {
                    const ns = this.currentCollection.namespace;
                    const name = this.currentCollection.name;
                    const version = this.selectedVersion;
                    const url = `/api/v3/collections/${ns}/${name}/versions/${version}/`;

                    const res = await fetch(url);
                    this.versionDetails = await res.json();
                    this.updateDetailHash();
                },

                async fetchDocs() {
                    const ns = this.currentCollection.namespace;
                    const name = this.currentCollection.name;
                    const version = this.selectedVersion;
                    const url = `/_ui/v1/docs/${ns}/${name}/versions/${version}/`;

                    const res = await fetch(url);
                    this.docs = await res.json();
                    if (this.docs.readme) {
                        this.renderedReadme = marked.parse(this.docs.readme);
                    }
                },

                get installURL() {
                    if (!this.currentCollection) return '';
                    const loc = window.location;
                    let port = loc.port ? ':' + loc.port : '';
                    return `${loc.protocol}//${loc.hostname}${port}/`;
                },

                get installName() {
                    if (!this.currentCollection) return '';
                    const ns = this.currentCollection.namespace;
                    const name = this.currentCollection.name;
                    return `${ns}.${name}==${this.selectedVersion}`;
                },

                get hasLinks() {
                    const metadata = this.versionDetails.metadata;
                    if (!metadata) return false;
                    return !!(metadata.repository || metadata.documentation || metadata.homepage || metadata.issues);
                },

                get hasDependencies() {
                    const dependencies = this.versionDetails.metadata?.dependencies;
                    return dependencies && Object.keys(dependencies).length > 0;
                },

                get dependencyEntries() {
                    const dependencies = this.versionDetails.metadata?.dependencies || {};
                    return Object.entries(dependencies);
                },

                openDependency(name, version) {
                    const parts = name.split('.');
                    const namespace = parts[0];
                    const collectionName = parts[1];

                    const col = this.collections.find(c => c.namespace === namespace && c.name === collectionName);
                    if (col) {
                        const shouldOmitVersion = /[*><>=]/.test(version);
                        const versionToUse = shouldOmitVersion ? null : version;

                        this.openCollection(col, versionToUse);
                    }
                },

                copyInstallCmd() {
                    const el = this.$refs.installCmd;
                    const text = el.textContent.trim();
                    navigator.clipboard.writeText(text).then(() => {
                        this.showToast = true;
                    }).catch(err => {
                        console.error('Failed to copy:', err);
                    });
                }
            }
        }
    </script>
</body>
</html>
